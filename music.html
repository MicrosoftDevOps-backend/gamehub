<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Maker</title>
  <style>
    html,body { height:100%; margin:0; background:#0b1220; font-family:system-ui,Segoe UI,Roboto,Arial; color:#dfe7ff; overflow:hidden; }
    #container { display:flex; flex-direction:column; height:100%; }
    #top { background:#071029; padding:12px; border-bottom:1px solid #2b6f86; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    #piano { flex:1; border:1px solid #2b6f86; margin:12px; background:#0f1724; overflow:auto; }
    #keys { display:grid; grid-template-columns:repeat(12,1fr); gap:4px; padding:12px; }
    .key { padding:8px; border:1px solid #2b6f86; background:#1a2f4a; color:#dfe7ff; cursor:pointer; text-align:center; border-radius:4px; user-select:none; }
    .key:hover { background:#2b4f6a; }
    .key.active { background:#6fbf3f; }
    button { background:#2b6f86; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button:hover { background:#3a8fa5; }
    select { background:#1a2f4a; color:#dfe7ff; border:1px solid #2b6f86; padding:6px; border-radius:4px; }
    input[type="range"] { vertical-align:middle; }
    label { display:flex; align-items:center; gap:6px; }
    #back { position:fixed; bottom:12px; left:12px; }
  </style>
</head>
<body>
  <div id="container">
    <div id="top">
      <label>Instrument: <select id="instrument">
        <option value="sine">Piano (Sine)</option>
        <option value="square">Square Wave</option>
        <option value="sawtooth">Sawtooth</option>
        <option value="triangle">Triangle</option>
      </select></label>
      <label>BPM: <input type="range" id="bpm" min="60" max="180" value="120" style="width:100px"></label>
      <span id="bpm-display">120</span>
      <button id="play-btn">Play</button>
      <button id="stop-btn">Stop</button>
      <button id="clear-btn">Clear</button>
      <button id="export-btn">Export WAV</button>
    </div>
    <div id="piano"></div>
  </div>
  <button id="back">‚Üê Back</button>

  <script>
    const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5', 'E5', 'F5', 'G5'];
    const freqs = {
      'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00,
      'B4': 493.88, 'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 739.99, 'G5': 783.99
    };
    const beatDuration = 0.5; // quarter note = 0.5s at 120 BPM
    let bpm = 120;
    let instrument = 'sine';
    let isPlaying = false;
    let playbackPosition = 0;

    // audio context
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const master = audioCtx.createGain();
    master.gain.value = 0.1;
    master.connect(audioCtx.destination);

    // piano roll data: 32 beats, 12 notes
    const roll = {};
    for (let n of notes) roll[n] = new Array(32).fill(false);

    // create piano roll UI
    const pianoEl = document.getElementById('piano');
    const keyGrid = document.createElement('div');
    keyGrid.id = 'keys';
    for (let n of notes) {
      for (let beat = 0; beat < 32; beat++) {
        const cell = document.createElement('div');
        cell.className = 'key';
        cell.textContent = beat === 0 ? n : '';
        cell.dataset.note = n;
        cell.dataset.beat = beat;
        cell.addEventListener('click', (e) => {
          roll[n][beat] = !roll[n][beat];
          cell.classList.toggle('active', roll[n][beat]);
        });
        keyGrid.appendChild(cell);
      }
    }
    pianoEl.appendChild(keyGrid);

    // synth function
    function playNote(freq, duration, type = 'sine') {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
      osc.connect(gain);
      gain.connect(master);
      osc.start(audioCtx.currentTime);
      osc.stop(audioCtx.currentTime + duration);
    }

    // playback
    async function playSequence() {
      isPlaying = true;
      document.getElementById('play-btn').disabled = true;
      const beatDur = (60 / bpm) * beatDuration;
      for (let beat = 0; beat < 32 && isPlaying; beat++) {
        for (let n of notes) {
          if (roll[n][beat]) playNote(freqs[n], beatDur * 0.8, instrument);
        }
        await new Promise((r) => setTimeout(r, beatDur * 1000));
      }
      isPlaying = false;
      document.getElementById('play-btn').disabled = false;
    }

    document.getElementById('play-btn').addEventListener('click', () => playSequence());
    document.getElementById('stop-btn').addEventListener('click', () => {
      isPlaying = false;
      document.getElementById('play-btn').disabled = false;
    });
    document.getElementById('clear-btn').addEventListener('click', () => {
      for (let n of notes) roll[n].fill(false);
      document.querySelectorAll('.key').forEach((k) => k.classList.remove('active'));
    });

    // BPM
    document.getElementById('bpm').addEventListener('input', (e) => {
      bpm = parseInt(e.target.value);
      document.getElementById('bpm-display').textContent = bpm;
    });

    // instrument
    document.getElementById('instrument').addEventListener('change', (e) => {
      instrument = e.target.value;
    });

    // WAV export
    document.getElementById('export-btn').addEventListener('click', async () => {
      const beatDur = (60 / bpm) * beatDuration;
      const totalDuration = 32 * beatDur;
      const sampleRate = 44100;
      const totalSamples = Math.ceil(totalDuration * sampleRate);
      const audioBuffer = audioCtx.createBuffer(1, totalSamples, sampleRate);
      const data = audioBuffer.getChannelData(0);

      // render notes to buffer
      for (let beat = 0; beat < 32; beat++) {
        for (let n of notes) {
          if (roll[n][beat]) {
            const startSample = Math.floor(beat * beatDur * sampleRate);
            const endSample = Math.floor((beat + beatDur * 0.8) * sampleRate);
            const freq = freqs[n];
            for (let i = startSample; i < endSample && i < totalSamples; i++) {
              const t = i / sampleRate;
              const beatStart = (beat * beatDur);
              const elapsed = t - beatStart;
              const noteDur = beatDur * 0.8;
              const envelope = Math.exp(-elapsed / (noteDur * 0.3)); // decay
              const phase = 2 * Math.PI * freq * elapsed;
              let sample = 0;
              if (instrument === 'sine') sample = Math.sin(phase);
              else if (instrument === 'square') sample = Math.sign(Math.sin(phase));
              else if (instrument === 'sawtooth') sample = (2 * (phase % (2 * Math.PI)) / (2 * Math.PI)) - 1;
              else if (instrument === 'triangle') {
                const p = (phase % (2 * Math.PI)) / (2 * Math.PI);
                sample = p < 0.5 ? 4 * p - 1 : 3 - 4 * p;
              }
              data[i] += sample * envelope * 0.1 / 12; // normalize
            }
          }
        }
      }

      // convert to WAV
      const wav = encodeWAV(data, sampleRate);
      const blob = new Blob([wav], { type: 'audio/wav' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'music.wav';
      a.click();
      URL.revokeObjectURL(url);
    });

    function encodeWAV(samples, sampleRate) {
      const fmt = encodeUTF8('fmt ');
      const audio = encodeUTF8('data');
      const wav = encodeUTF8('RIFF');
      const channels = 1;
      const bytesPerSample = 2;
      const blockAlign = channels * bytesPerSample;
      const byteRate = sampleRate * blockAlign;
      const dataLength = samples.length * bytesPerSample;
      const buffer = new ArrayBuffer(44 + dataLength);
      const view = new DataView(buffer);
      const writeString = (offset, str) => { for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i)); };
      const writeUint32 = (offset, value) => view.setUint32(offset, value, true);
      const writeUint16 = (offset, value) => view.setUint16(offset, value, true);
      writeString(0, 'RIFF');
      writeUint32(4, 36 + dataLength);
      writeString(8, 'WAVE');
      writeString(12, 'fmt ');
      writeUint32(16, 16);
      writeUint16(20, 1); // PCM
      writeUint16(22, channels);
      writeUint32(24, sampleRate);
      writeUint32(28, byteRate);
      writeUint16(32, blockAlign);
      writeUint16(34, 16); // bits per sample
      writeString(36, 'data');
      writeUint32(40, dataLength);
      for (let i = 0; i < samples.length; i++) {
        const s = Math.max(-1, Math.min(1, samples[i]));
        view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      }
      return buffer;
    }

    function encodeUTF8(str) { return str; }

    document.getElementById('back').addEventListener('click', () => { window.location.href = 'index.html'; });
  </script>
</body>
</html>
